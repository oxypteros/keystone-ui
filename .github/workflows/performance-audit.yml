name: Performance Check

# SETUP INSTRUCTIONS
# ------------------
# 1. Get a PageSpeed Insights API Key:
#    https://developers.google.com/speed/docs/insights/v5/get-started
# 2. Go to your Repo Settings > Secrets and Variables > Actions
# 3. Add a New Repository Secret:
#    Name: PAGESPEED_API_KEY
#    Value: [Your API Key]

on:
  schedule:
  - cron: '47 17 * * *'
  
  # Manual trigger with custom inputs
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL to Audit'
        required: true
        default: 'https://keystone-ui.oxypteros.com/'

env:
  # Configuration Variables
  DEFAULT_URL: "https://keystone-ui.oxypteros.com/"
  BADGE_FOLDER: ".github/badges"
  BADGE_BRANCH: "badges"

jobs:
  psi-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for API Key (Fork Guard)
        id: check_secrets
        run: |
          if [ -z "${{ secrets.PAGESPEED_API_KEY }}" ]; then
            echo "‚ö†Ô∏è  No PAGESPEED_API_KEY found."
            echo "If you are a user/fork, this workflow is skipped to prevent errors."
            echo "has_key=false" >> $GITHUB_OUTPUT
            exit 0 
          else
            echo "‚úÖ API Key found."
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi

      - name: Fetch Score from Google API
        if: steps.check_secrets.outputs.has_key == 'true'
        id: psi
        run: |
          RAW_URL="${{ inputs.target_url || env.DEFAULT_URL }}"
          API_KEY="${{ secrets.PAGESPEED_API_KEY }}"
          URL=$(printf '%s' "$RAW_URL" | jq -sRr @uri)
          MAX_SCORE=0

          echo "üî• Warming up: Sending a request via Google PSI..."
          curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=$URL&strategy=mobile&category=performance&key=$API_KEY" > /dev/null

          echo "‚è≥ Waiting 60 seconds for Cloudflare Cache/Worker to settle..."
          sleep 60

          echo "üöÄ Starting Actual Audit (Best of 3)..."

          for i in {1..3}
          do
            echo "Attempt $i/3..."
            RESPONSE=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=$URL&strategy=mobile&category=performance&key=$API_KEY")
            SCORE_RAW=$(echo $RESPONSE | jq '.lighthouseResult.categories.performance.score')

            if [ "$SCORE_RAW" == "null" ] || [ -z "$SCORE_RAW" ]; then
               echo "‚ùå Error: Could not fetch score on attempt $i. Check API Key or Quota."
               continue
            fi

            CURRENT_SCORE=$(echo "$SCORE_RAW * 100" | bc | awk '{print int($1+0.5)}')
            CURRENT_SCORE=${CURRENT_SCORE:-0}
            
            echo "üìä Run $i Score: $CURRENT_SCORE"

            if [ "$CURRENT_SCORE" -gt "$MAX_SCORE" ]; then
              MAX_SCORE=$CURRENT_SCORE
            fi

            if [ "$CURRENT_SCORE" -ge 99 ]; then
              echo "üöÄ Excellent score achieved. Stopping early."
              break
            fi

            if [ $i -lt 3 ]; then
              sleep 30
            fi
          done

          if [ "$MAX_SCORE" -eq "0" ]; then
             echo "‚ùå Failed to get any valid score."
             exit 1
          fi

          echo "üèÜ Final Selected Score: $MAX_SCORE"
          echo "score=$MAX_SCORE" >> $GITHUB_OUTPUT

      - name: Generate Performance Badge
        if: steps.check_secrets.outputs.has_key == 'true'
        env:
          SCORE: ${{ steps.psi.outputs.score }}
        run: |
          mkdir -p ../temp_badges_gen

          COLOR="bc2c00" # Red
          if (( $SCORE >= 90 )); then COLOR="266429"; fi # Green
          if (( $SCORE >= 50 && $SCORE < 90 )); then COLOR="BF5B00"; fi # Orange

          echo "Generating Performance Badge: ($SCORE)"
          
          # Output to the external temp directory
          curl -s -G "https://img.shields.io/badge/Performance-$SCORE-$COLOR" \
            -d style=flat \
            -d labelColor=%23FEFEFE \
            > "../temp_badges_gen/performance.svg"

      - name: Deploy Badge
        if: steps.check_secrets.outputs.has_key == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # üîç Check if 'badges' branch exists on remote
          if git ls-remote --exit-code --heads origin $BADGE_BRANCH; then

            echo "‚úÖ '$BADGE_BRANCH' branch detected. Switching..."
            git fetch origin $BADGE_BRANCH
            git checkout $BADGE_BRANCH
            
            # Copy from external temp dir
            cp ../temp_badges_gen/performance.svg .
            
            git add performance.svg
            TARGET_BRANCH="$BADGE_BRANCH"

          else
            echo "‚ÑπÔ∏è '$BADGE_BRANCH' branch NOT found. Falling back to folder: $BADGE_FOLDER..."
            
            # Ensure we are on the correct branch (crucial for fallbacks)
            git checkout ${{ github.ref_name }}
            # Pull latest changes to avoid 'non-fast-forward' errors if Main updated during audit
            git pull origin ${{ github.ref_name }} --rebase
            
            mkdir -p $BADGE_FOLDER
            
            # Copy from external temp dir
            cp ../temp_badges_gen/performance.svg $BADGE_FOLDER/
            
            git add $BADGE_FOLDER/performance.svg
            TARGET_BRANCH="${{ github.ref_name }}"
          fi

           # üíæ COMMIT & PUSH
          if git diff --staged --quiet; then
            echo "No changes to badge."
          else
            git commit -m "ü§ñ Update Performance Badge: ${{ steps.psi.outputs.score }} [skip ci]"
            git push origin $TARGET_BRANCH
            echo "üöÄ Pushed to $TARGET_BRANCH"
          fi