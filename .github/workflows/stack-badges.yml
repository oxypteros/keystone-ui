name: Generate Dev Stack Badges
on:
  push:
    paths:
      - 'package.json'
  workflow_dispatch:

jobs:
  update-badges:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Generate Badges to Temp Directory
        run: |
          # Temp dir outside the repo
          mkdir -p ../temp_badges_gen

          # Function to generate badge
          generate_badge() {
            NAME=$1
            PACKAGE_JSON_KEY=$2
            COLOR=$3
            LOGO=$4
            LOGO_COLOR=$5
            LABEL_COLOR=$6
            
            RAW_VERSION=$(jq -r ".devDependencies[\"$PACKAGE_JSON_KEY\"] // .dependencies[\"$PACKAGE_JSON_KEY\"]" package.json)
            if [ "$RAW_VERSION" == "null" ] || [ -z "$RAW_VERSION" ]; then return 0; fi
            VERSION=$(echo "$RAW_VERSION" | sed 's/[\^~v]//g' | cut -d. -f1,2)
            if [ "$VERSION" == "null" ] || [ -z "$VERSION" ]; then VERSION="latest"; fi

            # Output to the TEMP directory
            curl -s -G "https://img.shields.io/badge/$NAME-$VERSION-$COLOR" \
              -d style=flat \
              -d logo=$LOGO \
              -d logoColor=$LOGO_COLOR \
              -d labelColor=%23$LABEL_COLOR \
              > "../temp_badges_gen/$LOGO.svg"
          }

          # BADGES to GENERATE from deps
          generate_badge "AlpineJs" "@alpinejs/csp" "8BC0D0" "alpinedotjs" "8BC0D0" "F0F0F0"
          generate_badge "Tailwind" "tailwindcss" "06B6D4" "tailwindcss" "06B6D4" "F0F0F0"

          # BADGES to GENERATE from engines
           HUGO_VERSION=$(jq -r '.engines.hugo' package.json)

          if [ "$HUGO_VERSION" == "null" ] || [ -z "$HUGO_VERSION" ]; then
             HUGO_VERSION="unknown"
          fi

          curl -s -G "https://img.shields.io/badge/Hugo-$HUGO_VERSION-FF4088" \
            -d style=flat \
            -d logo=hugo \
            -d logoColor=%23FF4088 \
            -d labelColor=%23F0F0F0 \
            > "../temp_badges_gen/hugo.svg"

      - name: Deploy Badges (Conditional Logic)
        run: |
          # Configure Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # üîç CHECK: Does the 'badges' branch exist on Remote?
          if git ls-remote --exit-code --heads origin badges; then
            echo "‚úÖ 'badges' branch detected. Switching context..."
            
            # Fetch and Switch to the orphan branch
            git fetch origin badges
            git checkout badges
            
            # Copy from temp folder to ROOT (overwrite existing)
            cp ../temp_badges_gen/*.svg .
            
            TARGET_BRANCH="badges"
          else
            echo "‚ÑπÔ∏è 'badges' branch NOT found. Falling back to standard .github/badges folder..."
            
            # Ensure we are on the correct starting branch (not detached head)
            git checkout ${{ github.ref_name }}
            
            # Create standard folder
            mkdir -p .github/badges
            
            # Copy from temp folder to .github/badges
            cp ../temp_badges_gen/*.svg .github/badges/
            
            TARGET_BRANCH="${{ github.ref_name }}"
          fi

          # üíæ COMMIT & PUSH
          git add .

          if git diff --staged --quiet; then
            echo "No changes to badges."
          else
            git commit -m "ü§ñ Update Stack Badges [skip ci]"
            git push origin $TARGET_BRANCH
            echo "üöÄ Pushed changes to $TARGET_BRANCH"
          fi
